<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Vera Plugin for Nest Thermostats and Smoke and Carbon Monoxide Detectors</title>
    <meta name="description" content="This plugin will monitor and control your Nest thermostat(s)  and/or Protect smoke/CO detector(s) through your Vera home automation gateway.
">

    <link rel="stylesheet" href="/vera-nest/css/main.css">
    <link rel="canonical" href="http://watou.github.io/vera-nest/">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/vera-nest/">Vera Plugin for Nest</a>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <div class="post">

  <header class="post-header">
    <h1 class="post-title">Vera Plugin for Nest Thermostats and Smoke and Carbon Monoxide Detectors</h1>
  </header>

  <article class="post-content">
    <h2 id="purpose">Purpose</h2>
<p>This plugin will monitor and control your <a href="http://www.nest.com">Nest</a> thermostat(s) and/or Protect smoke/CO detector(s) through your <a href="http://www.micasaverde.com">Vera</a> home automation gateway.</p>

<h2 id="features">Features</h2>

<ul>
  <li>
    <p>Monitor thermostat mode, fan mode, current and set point temperatures, humidity level, running states, battery level and “home/away” status.</p>
  </li>
  <li>
    <p>Control temperature set points, thermostat mode and fan mode.</p>
  </li>
  <li>
    <p>Set your house to Home or Away, switching all your Nest thermostats to an energy-saving mode when unoccupied.</p>
  </li>
  <li>
    <p>Monitor smoke/CO alarm status and battery level.</p>
  </li>
</ul>

<figure>
  <img src="images/screen-shot.jpg" alt="Devices in Vera" />
  <figcaption>An example of the Nest devices shown in Vera (UI5).</figcaption>
</figure>

<h2 id="how-to-use-the-plugin">How to Use the Plugin</h2>

<p>Open the settings for the Nest device that was created at plugin installation, and set your <code>nest.com</code> user name and password.  Also choose a polling frequency (in seconds) if you want to poll more or less often than the default 120 seconds.  You may not poll more often than every 60 seconds, as this might be considered abusive by the <code>nest.com</code> servers.</p>

<p>Shortly after saving your changes, the plugin will login to <code>nest.com</code> and retrieve all of the locations associated with your account, and all the thermostats and smoke/CO detectors within each location.  Since the thermostat also contains a humidity sensor, the plugin also creates a humidistat device for each thermostat it discovers.  Since the Protect(r) contains both smoke and CO detectors, the plugin will create a separate device for each function.  The plugin will create the devices in Vera using the names discovered from <code>nest.com</code>.  Shown below is an example list of devices that have been created in your Vera:</p>

<pre><code>Nest				(your account information)
Home				(your home or other location)
Ground Floor	   		(thermostat functions)
Ground Floor Humidity		(humidistat functions)
Master Bedroom			(2nd thermostat in Home)
Master Bedroom Humidity 	(humidistat functions)
Hallway (Upstairs) Smoke 	(smoke detector)
Hallway (Upstairs) CO 		(carbon monoxide detector)
...
</code></pre>

<h3 id="thermostat-controlling-the-precision-of-reported-temperatures">Thermostat: Controlling the Precision of Reported Temperatures</h3>

<p>The Nest thermostat internally reports very precise temperatures in Celsius, but by default the plugin will report whole number values (regardless of whether Fahrenheit or Celsius temperature scales are used).  You can control this however, by specifying your preferred rounding precision with a device variable on the main Nest device called <code>TemperatureScale</code>.  The value you provide is the denominator D in the fraction 1/D, the fractional value to which the temperature should be rounded.  For example, providing 2 means that temperatures will be rounded to the nearest 1/2 (0.5) of a degree.  Providing 10 would round to the nearest tenth (0.10) of a degree.</p>

<p>The default value for <code>TemperatureScale</code> is 1, meaning only whole degrees are reported by default.</p>

<p>Notes</p>

<ol>
  <li>This feature will not allow you to change the setpoint sliders in the user interface to fractional values; that is outside the scope of the plugin.</li>
  <li>Using this feature may cause unwanted side-effects that are outside the scope of the plugin’s control.  Please test your configuration thoroughly before determining that a non-1 value is for you.</li>
  <li>This feature is agnostic to whether you display temperatures in Fahrenheit or Celsius, but it may be of more value to Celsius users to set <code>TemperatureScale</code> to 2 to achieve near-Fahrenheit granularity.</li>
</ol>

<h2 id="notes-and-limitations">Notes and Limitations</h2>

<ul>
  <li>
    <p>I am presently only able to test the plugin against UI5 (1.5.622), but there are reports that it is working properly against the latest UI7 firmware.</p>
  </li>
  <li>
    <p>The plugin is based on an unsupported interface to Nest, which may break or otherwise become inaccessible at any time.</p>
  </li>
  <li>
    <p>The plugin stores your nest.com login credentials in plaintext in device variables which can be displayed clearly in UI5 and potentially other places.</p>
  </li>
  <li>
    <p>Updates to the state of the location, thermostat, humidistat, smoke and carbon monoxide detector devices can take up to the polling number of seconds (120 by default) to be reflected in the UPnP devices (or as quickly as 5 seconds).</p>
  </li>
</ul>

<ul>
  <li>
    <p>For the thermostat, <code>BatteryLevel</code> percentage is tied to a voltage range of 3.6 to 3.9 volts.  Any actual voltage below 3.6 is considered 0% and any voltage above 3.9 is considered 100%.  (Battery level may be important to some users, as the battery is charged by leeching power during heating or cooling.  If there is a problem, the battery level will continue to decline until the device turns off the proximity function, wi-fi and then itself.)</p>
  </li>
  <li>
    <p>For the smoke/CO detector, <code>BatteryLevel</code> percentage is tied to a voltage range of 4200 to 5400 millivolts.  Any actual millivoltage below 4200 is considered 0%
and any millivoltage above 5400 is considered 100%.  These numbers may change in the future, thereby altering the current percentage after the code change.</p>
  </li>
  <li>
    <p>The humidistat device currently only implements the humidity sensor service, but as the <a href="http://nest.com/blog/2012/10/02/the-next-generation-nest-thermostat/">2nd generation Nest thermostats</a> can also control humidifers and dehumidifiers, this device type will be extended to implement new services.</p>
  </li>
</ul>

<ul>
  <li>The “Home/Away” device implements <code>urn:schemas-upnp-org:service:HouseStatus:1</code>, but since I didn’t find an <code>S_HouseStatus1.xml</code> file in my Vera, one is packaged with the plugin. (This device also implements <code>urn:schemas-upnp-org:service:SwitchPower:1</code>.)</li>
</ul>

<h2 id="license">License</h2>

<p>Copyright © 2012-2014  John W. Cocula and others</p>

<p>This program is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.</p>

<p>This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a></p>

<p>The source code repository and issue list can be located at <a href="https://github.com/watou/vera-nest">https://github.com/watou/vera-nest</a>.</p>

<h2 id="feedback">Feedback</h2>

<p>Please contact me through the <a href="http://forum.micasaverde.com/index.php?action=profile;u=19018">micasaverde.com forum</a>.  All tips are gratefully accepted!</p>

<div style="text-align:center">
<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
<input type="hidden" name="cmd" value="_s-xclick" />
<input type="hidden" name="hosted_button_id" value="ZX4FRDJ5PDRTG" />
<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!" />
<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1" />
</form>
</div>

<h2 id="thanks">Thanks</h2>

<p><code>futzle</code>, <code>garretwp</code>, <code>guessed</code>, <code>RichardTSchaefer</code> and others on the forum for their kind assistance.
<code>hugheaves</code> for his <code>decompressScript</code> shell script workaround for the problem with deploying compressed modules and for providing his open-source plugin for a different make/model thermostat.</p>

<h2 id="future-plans">Future Plans</h2>

<ul>
  <li>See about integrating historical energy usage data into the plugin.</li>
  <li>Have status updates arrive more quickly (if it turns out to be feasible).</li>
  <li>Report the heating or cooling stage, since Nest supports multiple heating and cooling stages.</li>
  <li>More automation.</li>
  <li>Implement Humidistat functionality to control humidity from Vera.</li>
</ul>

<h2 id="history">History</h2>

<h3 id="v18">2014-08-08    v1.8</h3>

<p>Fixed issue:</p>

<ul>
  <li>Remove bad version checking code (<a href="https://github.com/watou/vera-nest/issues/35">#35</a>)</li>
</ul>

<h3 id="v17">2014-07-30    v1.7</h3>

<p>Enhancements:</p>

<ul>
  <li>Added the creation of a smoke detector device and carbon monoxide detector device for each Nest Protect(r) that is listed in the user’s account at nest.com. (<a href="https://github.com/watou/vera-nest/issues/32">#32</a>).  (Reminder of disclaimer: Do not rely on any of these devices or any aspect of the plugin to protect the health or safety of anyone or anything.  Please read the full license for further information.)</li>
  <li>Add “where” location info to device names (e.g., Hallway, Den, Basement, etc.) on device creation if specified (<a href="https://github.com/watou/vera-nest/issues/33">#33</a>)</li>
  <li>Append meaningful descriptions to child device names (Humidity, Smoke, CO) (<a href="https://github.com/watou/vera-nest/issues/34">#34</a>)</li>
</ul>

<h3 id="v16">2014-03-22    v1.6</h3>

<p>Fixed issue:</p>

<ul>
  <li>Now, on attempting to get status, nest.com’s transport servers can return HTTP 200 (OK) but not the JSON payload we’re expecting (likely when the token has expired), and this was causing the code to expect data that wasn’t there, killing future polling cycles.  This fix adds better error checking. (<a href="https://github.com/watou/vera-nest/issues/31">#31</a>)</li>
</ul>

<h3 id="v15">2014-03-15    v1.5</h3>

<p>Fixed issue:</p>

<ul>
  <li>Replaced use of sslv3 with tlsv1 to fix a new connectivity issue reported by some users (<a href="https://github.com/watou/vera-nest/issues/30">#30</a>)</li>
</ul>

<h3 id="v14">2014-01-16    v1.4</h3>

<p>Fixed issues:</p>

<ul>
  <li>Disable Heat or Cool buttons when not can_heat or can_cool (<a href="https://github.com/watou/vera-nest/issues/28">#28</a>)</li>
  <li>Move the “Home/Away” device from DEVICE_CATEGORY_SWITCH (3) to DEVICE_CATEGORY_HVAC (5) (<a href="https://github.com/watou/vera-nest/issues/29">#29</a>)</li>
</ul>

<h3 id="v13">2013-10-09    v1.3</h3>

<p>Fixed issues:</p>

<ul>
  <li>Added triggers for ModeState changes (<a href="https://github.com/watou/vera-nest/issues/25">#25</a>)</li>
  <li>Cached ModeStatus on set so that immediate setpoint changes work (<a href="https://github.com/watou/vera-nest/issues/26">#26</a>)</li>
  <li>Added <code>TemperatureScale</code> device variable for (optionally) more precise current temperature values (<a href="https://github.com/watou/vera-nest/issues/27">#27</a>)</li>
</ul>

<h3 id="v12">2013-07-01    v1.2</h3>

<p>Fixed issues:</p>

<ul>
  <li>Setting home/away fails on Vera2 (<a href="https://github.com/watou/vera-nest/issues/21">#21</a>)</li>
  <li>Detect when there is no fan installed (<a href="https://github.com/watou/vera-nest/issues/24">#24</a>)</li>
</ul>

<h3 id="v11">2013-04-06    v1.1</h3>

<p>Fixed issue:</p>

<ul>
  <li>The Home/Away command stopped working (<a href="https://github.com/watou/vera-nest/issues/19">#19</a>)</li>
</ul>

<h3 id="v10">2013-02-13    v1.0</h3>

<p>Fixed issues:</p>

<ul>
  <li>Send away_timestamp in milliseconds, not seconds (<a href="https://github.com/watou/vera-nest/issues/9">#9</a>)</li>
  <li>Improve task message on login failure (<a href="https://github.com/watou/vera-nest/issues/10">#10</a>)</li>
  <li>Triggers needed for setting heat/cool setpoints in the other direction (<a href="https://github.com/watou/vera-nest/issues/11">#11</a>)</li>
  <li>Added a <code>Logging</code> variable to the main Nest account device to increase log output (<a href="https://github.com/watou/vera-nest/issues/15">#15</a>)</li>
  <li>Added variable text under the setpoint sliders that shows the current ModeState (<a href="https://github.com/watou/vera-nest/issues/16">#16</a>)</li>
</ul>

<h3 id="v09">2012-12-27    v0.9</h3>
<ul>
  <li>Only set device variables if they have changed (to decrease log output)</li>
  <li>Set the <code>urn:micasaverde-com:serviceId:HaDevice1</code> variable <code>LastUpdate</code> for the location, thermostat and humidistat devices.  For the location device, this is the Unix timestamp most recently retrieved from <code>nest.com</code> for that location’s status.  For the thermostat and humidistat devices, <code>LastUpdate</code> (and <code>BatteryDate</code>) are the Unix timestamp from <code>nest.com</code> (also without any synchronization to the Vera’s clock) that indicates the last time the thermostat connected to <code>nest.com</code>.</li>
</ul>

<h3 id="v08">2012-12-15    v0.8</h3>
<ul>
  <li>Decreased the potential for excessive status polling.</li>
  <li>Removed <code>Clearing...</code> log message from every poll and other log/debug cleanup.</li>
  <li>Rounded incoming Celsius degrees just like Fahrenheit.  (Sorry for loss of precision; see <a href="http://forum.micasaverde.com/index.php?topic=6133.5">http://forum.micasaverde.com/index.php?topic=6133.5</a>.)</li>
</ul>

<h3 id="v07">2012-12-11    v0.7</h3>
<ul>
  <li>Removed the special case where heat and cool setpoints would show the same value.</li>
  <li>Fixed the plugin’s inability to set the thermostat mode to <code>Off</code>.</li>
</ul>

<h3 id="v06">2012-12-11    v0.6</h3>
<ul>
  <li>Initial plugin upload to <a href="http://apps.mios.com">http://apps.mios.com</a></li>
</ul>


  </article>

</div>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Vera Plugin for Nest</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>Vera Plugin for Nest</li>
          <li><a href="mailto:"></a></li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/watou">
              <span class="icon  icon--github">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
                </svg>
              </span>

              <span class="username">watou</span>
            </a>
          </li>
          

          
          <li>
            <a href="https://twitter.com/jcocula">
              <span class="icon  icon--twitter">
                <svg viewBox="0 0 16 16">
                  <path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                  c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
                </svg>
              </span>

              <span class="username">jcocula</span>
            </a>
          </li>
          
        </ul>
      </div>

      <div class="footer-col  footer-col-3">
        <p class="text">This plugin will monitor and control your Nest thermostat(s)  and/or Protect smoke/CO detector(s) through your Vera home automation gateway.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
